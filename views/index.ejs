<%- include('partials/header', { pageTitle: "Home" }) %>

<div class="row mt-3 g-3 align-items-stretch justify-content-center">
  <div class="col-12 col-md-5">
    <input
      id="donorName"
      type="text"
      class="form-control fs-4 fw-bold text-center"
      placeholder="Enter Donor Name"
      autocomplete="off"
      required
    />
  </div>
  <div class="col-12 col-md-3">
    <input
      id="dateDisplay"
      type="text"
      class="form-control fs-4 fw-bold text-center"
      placeholder="Date"
      autocomplete="off"
    />
  </div>
</div>
<div id="donorSuggestions" class="list-group mt-2"></div>

<!-- Toy Buttons -->
<div class="container mt-5">
  <div class="row g-3">
    <% const items = [
      {label:'Boy 0-2', id:'B02'}, {label:'Girl 0-2', id:'G02'},
      {label:'Boy 3-5', id:'B35'}, {label:'Girl 3-5', id:'G35'},
      {label:'Boy 6-8', id:'B68'}, {label:'Girl 6-8', id:'G68'},
      {label:'Boy 9-11', id:'B911'}, {label:'Girl 9-11', id:'G911'},
      {label:'Boy 12-14', id:'B1214'}, {label:'Girl 12-14', id:'G1214'},
      {label:'Book', id:'Book'}, {label:'Stocking Stuffer', id:'Stocking'},
      {label:'Stuffed Animals', id:'Stuffie'}, {label:'Bicycle', id:'Bike'}
    ] %>

    <% items.forEach(item => { %>
      <div class="col-6 col-sm-4 col-md-3 col-lg-3 d-grid">
        <button class="btn btn-primary btn-lg" id="<%= item.id %>Add"><%= item.label %></button>
      </div>
      <div class="col-2 col-sm-2 col-md-1 d-grid">
        <button class="btn btn-danger btn-lg" id="<%= item.id %>Remove">-</button>
      </div>
      <div class="col-2 col-sm-2 col-md-1 d-grid">
        <button class="btn btn-secondary btn-lg" onclick="openBulkModal('<%= item.id %>Count')">Bulk</button>
      </div>
      <div class="col-2 col-sm-2 col-md-1 d-grid">
        <input type="text" class="form-control btn-lg text-center" value="0" readonly id="<%= item.id %>Count" />
      </div>
    <% }) %>
  </div>
</div>

<div class="px-4 my-5 text-center">
  <h2 class="display-6 fw-bold text-body-emphasis">Final Check</h2>
  <div class="col-lg-8 mx-auto">
    <p class="lead mb-4">
      Ensure you've entered the Donor's name. Double check form entries to
      ensure they look reasonable and complete.
    </p>
    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
      <button
        type="button"
        class="btn btn-primary btn-lg px-4 gap-3"
        id="submitDonation"
      >
        Submit
      </button>
    </div>
  </div>
</div>

<!-- Bulk Modal -->
<div class="modal fade" id="bulkModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Bulk Add</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          onclick="closeBulkModal()"
        ></button>
      </div>
      <div class="modal-body">
        <label for="bulkAmount">Quantity:</label>
        <input type="text" id="bulkAmount" class="form-control" value="" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeBulkModal()">Cancel</button>
        <button type="button" class="btn btn-primary" id="applyBulk">Apply</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Auto-set date
  $("#dateDisplay").val(new Date().toLocaleDateString());

  const items = [
    'B02','G02','B35','G35','B68','G68','B911','G911','B1214','G1214',
    'Book','Stocking','Stuffie','Bike'
  ];

  items.forEach(id => {
    $("#" + id + "Add").click(() => {
      let val = parseInt($("#" + id + "Count").val());
      $("#" + id + "Count").val(val + 1);
    });
    $("#" + id + "Remove").click(() => {
      let val = parseInt($("#" + id + "Count").val());
      $("#" + id + "Count").val(val > 0 ? val - 1 : 0);
    });
  });

  let bulkTarget = null;
  const modalEl = document.getElementById("bulkModal");
  const bulkModal = bootstrap.Modal.getOrCreateInstance(modalEl);
  const bulkAmountInput = document.getElementById("bulkAmount");

  modalEl.addEventListener("shown.bs.modal", () => {
    bulkAmountInput.focus();
  });

  function applyBulk() {
    const raw = bulkAmountInput.value.trim();
    if (!/^-?\d+$/.test(raw)) return;
    const amount = parseInt(raw, 10);
    const inputEl = document.getElementById(bulkTarget);
    let newVal = (parseInt(inputEl.value, 10) || 0) + amount;
    if (newVal < 0) newVal = 0;
    inputEl.value = newVal;
    bulkModal.hide();
  }

  document.getElementById("applyBulk").addEventListener("click", applyBulk);
  bulkAmountInput.addEventListener("keydown", (e) => { if(e.key==="Enter"){ e.preventDefault(); applyBulk(); }});

  function openBulkModal(targetId){
    bulkTarget = targetId;
    bulkAmountInput.value = "";
    bulkModal.show();
  }
  function closeBulkModal(){
    const modal = bootstrap.Modal.getInstance(modalEl);
    if(modal) modal.hide();
  }

  $("#submitDonation").click(() => {
    const donor = $("#donorName").val().trim();
    if(!donor){ alert("Please enter a donor name."); $("#donorName").focus(); return; }

    const data = {};
    
    // Correct mapping from front-end IDs to DB columns
    const mapping = {
      B02: "boy02",
      G02: "girl02",
      B35: "boy35",
      G35: "girl35",
      B68: "boy68",
      G68: "girl68",
      B911: "boy911",
      G911: "girl911",
      B1214: "boy1214",
      G1214: "girl1214",
      Book: "book",
      Stocking: "stocking",
      Stuffie: "stuffie",
      Bike: "bike"
    };

    items.forEach(id => {
      data[mapping[id]] = parseInt($("#" + id + "Count").val());
    });

    data.donor = donor;
    data.date = $("#dateDisplay").val();

    $.post("/submit", data, (res)=>{
      alert("Donation submitted!");
      $("#donorName").val("");
      items.forEach(id=>$("#"+id+"Count").val(0));
    });
  });
</script>

<%- include('partials/footer') %>