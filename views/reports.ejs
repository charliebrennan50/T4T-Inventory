<%- include('partials/header', { pageTitle: "Instructions" }) %>

<!-- Reports page HTML -->

<h3
  role="button"
  data-bs-toggle="collapse"
  data-bs-target="#toyTotals"
  class="mb-3"
>
  Donation Totals by Date
</h3>
<div class="collapse" id="toyTotals">
  <div id="report-toys"></div>
</div>

<h3
  role="button"
  data-bs-toggle="collapse"
  data-bs-target="#totalsChart"
  class="mb-3"
>
  Donation Totals Chart
</h3>
<div
  class="collapse"
  id="totalsChart"
  style="max-width: 800px; margin: 0 auto; padding: 20px"
>
  <canvas id="donationChart" width="600" height="300"></canvas>
</div>

<h3
  role="button"
  data-bs-toggle="collapse"
  data-bs-target="#donorTotals"
  class="mb-3"
>
  Donation Totals by Donor
</h3>
<div class="collapse" id="donorTotals">
  <div id="report-donors"></div>
</div>

<h3
  role="button"
  data-bs-toggle="collapse"
  data-bs-target="#eventTotals"
  class="mb-3"
>
  Donation Totals by Event
</h3>
<div class="collapse" id="eventTotals">
  <div id="event-donors"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  // --- Totals by Date ---
  async function loadReports() {
    const tableDiv = document.getElementById("report-toys");
    const chartCanvas = document.getElementById("donationChart");

    if (!tableDiv || !chartCanvas) return;

    let totalsByDate = [];
    try {
      totalsByDate = await fetch("/api/reports/totals-by-date").then(r => r.json());
    } catch (err) {
      console.error("Failed to fetch totals-by-date:", err);
    }

    if (!Array.isArray(totalsByDate) || totalsByDate.length === 0) {
      tableDiv.innerHTML = "<p>No data available.</p>";
      return;
    }

    // Render table
    tableDiv.innerHTML = `
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Date</th>
            <th>Age 0-2</th>
            <th>Age 3-5</th>
            <th>Age 6-8</th>
            <th>Age 9-11</th>
            <th>Age 12-14</th>
            <th>Books</th>
            <th>Stuffies</th>
            <th>Bikes</th>
            <th>Stockings</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          ${totalsByDate.map(row => {
            const d = new Date(row.date);
            const formattedDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
            return `
              <tr>
                <td>${formattedDate}</td>
                <td>${row.age_0_2}</td>
                <td>${row.age_3_5}</td>
                <td>${row.age_6_8}</td>
                <td>${row.age_9_11}</td>
                <td>${row.age_12_14}</td>
                <td>${row.books}</td>
                <td>${row.stuffies}</td>
                <td>${row.bikes}</td>
                <td>${row.stockings}</td>
                <td>${row.total_items}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;

    // Render chart
    const labels = totalsByDate.map(row => {
      const d = new Date(row.date);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    });
    const totals = totalsByDate.map(row => row.total_items);

    new Chart(chartCanvas.getContext("2d"), {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Total Toys",
          data: totals,
          borderColor: "blue",
          backgroundColor: "rgba(54,162,235,0.6)",
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: "Date" } },
          y: { title: { display: true, text: "Total Toys" }, beginAtZero: true }
        }
      }
    });
  }

  loadReports();

  // --- Totals by Donor ---
  async function loadDonorReport() {
    const tableDiv = document.getElementById("report-donors");
    if (!tableDiv) return;

    let totalsByDonor = [];
    try {
      totalsByDonor = await fetch("/api/reports/totals-by-donor").then(r => r.json());
    } catch (err) {
      console.error("Failed to fetch totals-by-donor:", err);
    }

    if (!Array.isArray(totalsByDonor) || totalsByDonor.length === 0) {
      tableDiv.innerHTML = "<p>No data available.</p>";
      return;
    }

    tableDiv.innerHTML = `
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Donor</th>
            <th>Number of Donations</th>
            <th>Total Toys</th>
            <th>Total Books</th>
            <th>Total Stuffers</th>
          </tr>
        </thead>
        <tbody>
          ${totalsByDonor.map(row => `
            <tr>
              <td>${row.donor}</td>
              <td>${row.num_donations}</td>
              <td>${row.total_toys}</td>
              <td>${row.total_books}</td>
              <td>${row.total_stocking}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  loadDonorReport();

  // --- Totals by Event ---
  async function loadEventReport() {
    const tableDiv = document.getElementById("event-donors");
    if (!tableDiv) return;

    let totalsByEvent = [];
    try {
      totalsByEvent = await fetch("/api/reports/totals-by-event").then(r => r.json());
    } catch (err) {
      console.error("Failed to fetch totals-by-event:", err);
    }

    if (!Array.isArray(totalsByEvent) || totalsByEvent.length === 0) {
      tableDiv.innerHTML = "<p>No data available.</p>";
      return;
    }

    tableDiv.innerHTML = `
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Donor</th>
            <th>Number of Donations</th>
            <th>Total Toys</th>
            <th>Total Books</th>
            <th>Total Stuffers</th>
          </tr>
        </thead>
        <tbody>
          ${totalsByEvent.map(row => `
            <tr>
              <td>${row.donor}</td>
              <td>${row.num_donations}</td>
              <td>${row.total_toys}</td>
              <td>${row.total_books}</td>
              <td>${row.total_stocking}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  loadEventReport();
});
</script>